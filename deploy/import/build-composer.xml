<?xml version="1.0" encoding="UTF-8"?>
<project name="Composer" default="composer-install" basedir="/var/www/html">
    <property file="/deploy/build.properties"/>
    <property name="bin.composer" value="bin-composer"/>
    <target name="validate-composer-version" description="Ensure composer version">
        <exec command="${bin.composer} -V" passthru="true" checkreturn="true"/>
    </target>
    <target name="validate-composer-properties" description="Ensure all require properties are defined">
        <if>
            <not>
                <isset property="magento2.repository-key"/>
            </not>
            <then>
                <fail>magento.repository-key is not specified</fail>
            </then>
        </if>
        <if>
            <not>
                <isset property="magento2.repository-secret"/>
            </not>
            <then>
                <fail>magento.repository-secret is not specified</fail>
            </then>
        </if>
        <echo message="Done"/>
    </target>
    <target name="validate-composer-auth" description="Ensure auth.json exists">
        <property name="output.IS_FILE_EXISTS" value="false"/>
        <exec command="if [ ! -f '/var/www/html/auth.json' ]; then echo 'true'; else echo 'false'; fi;"
              outputProperty="output.IS_FILE_NOT_EXISTS"/>
        <if>
            <equals arg1="${output.IS_FILE_NOT_EXISTS}" arg2="true"/>
            <then>
                <copy file="${basedir}/auth-template.json" tofile="${basedir}/auth.json" overwrite="true">
                    <filterchain>
                        <replacetokens begintoken="%%" endtoken="%%">
                            <token key="magento2.repository-key" value="${magento2.repository-key}"/>
                            <token key="magento2.repository-secret" value="${magento2.repository-secret}"/>
                        </replacetokens>
                    </filterchain>
                </copy>
            </then>
            <else>
                <echo message="Done"/>
            </else>
        </if>
    </target>
    <target name="validate-composer"
            depends="validate-composer-properties, validate-composer-version, validate-composer-auth"
            description="Ensure composer requirements">
        <echo message="Done"/>
    </target>
    <target name="composer-install"
            depends="validate-composer"
            description="Install Composer">
        <exec command="${bin.composer} install --prefer-dist --no-progress --no-interaction"
              passthru="true"
              checkreturn="true"/>
    </target>
    <target name="composer-install-optimized"
            depends="validate-composer"
            description="Install Composer">
        <exec command="${bin.composer} install --prefer-dist --no-progress --no-interaction --no-dev --optimize-autoloader"
              passthru="true"
              checkreturn="true"/>
    </target>
</project>
